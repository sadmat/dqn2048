import { HorizontalBox, VerticalBox, Button } from "std-widgets.slint";
import { Style, Colors } from "../styles.slint";
import { PlotSize } from "../size.slint";
import { UiTrainingState, Actions } from "../globals.slint";

component StatWidget inherits Rectangle {
    in property <string> name;
    in property <string> value;

    HorizontalBox {
        padding: 0;
        padding-bottom: 8px;
        alignment: space-between;

        Text {
            text: name;
            color: gray;
        }

        Text {
            text: value;
        }
    }
}

export component TrainingWidget inherits Rectangle {
    in property <UiTrainingState> state;
    in property <int> epoch;
    in property <float> epochs-per-second;
    in property <int> best-score;
    in property <int> best-tile;
    in property <image> score-plot;
    in property <image> reward-plot;
    in property <image> best-tile-plot;
    out property <PlotSize> score-plot-size: { width: score-plot-image.width / 1px, height: score-plot-image.height / 1px };
    out property <PlotSize> reward-plot-size: { width: reward-plot-image.width / 1px, height: reward-plot-image.height / 1px };
    out property <PlotSize> best-tile-plot-size: { width: best-tile-plot-image.width / 1px, height: best-tile-plot-image.height / 1px };

    HorizontalBox {
        VerticalBox {
            min-width: 1000px;
            min-height: 600px;

            Rectangle {
                border-radius: Style.corner-radius;
                background: Colors.game-background;

                score-plot-image := Image {
                    source: score-plot;
                    width: 100%;
                    height: 100%;
                }
            }

            HorizontalBox {
                padding-top: 0;
                padding-left: 0;
                padding-right: 0;

                Rectangle {
                    border-radius: Style.corner-radius;
                    background: Colors.game-background;

                    reward-plot-image := Image {
                        source: reward-plot;
                        width: 100%;
                        height: 100%;
                    }
                }

                Rectangle {
                    border-radius: Style.corner-radius;
                    background: Colors.game-background;

                    best-tile-plot-image := Image {
                        source: best-tile-plot;
                        width: 100%;
                        height: 100%;
                    }
                }
            }
        }

        VerticalBox {
            width: 200px;
            StatWidget {
                name: "state";
                value: training-state-string(state);
            }

            StatWidget {
                name: "epoch";
                value: epoch;
            }

            StatWidget {
                name: "epochs/s";
                value: epochs-per-second.to-fixed(1);
            }

            StatWidget {
                name: "best score";
                value: best-score;
            }

            StatWidget {
                name: "best tile";
                value: best-tile;
            }

            Rectangle { }

            Button {
                text: root.state == UiTrainingState.idle ? "start" : "pause";
                clicked => {
                    if (root.state == UiTrainingState.idle) {
                        Actions.start-training();
                    } else {
                        Actions.pause-training();
                    }
                }
            }
        }
    }

    function training-state-string(state: UiTrainingState) -> string {
        return state == UiTrainingState.idle ? "idle" : state == UiTrainingState.training ? "training" : "unknown";
    }
}
